<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kmo.kome.mapper.MemoMapper">

    <!--
        功能: 查询 Memo 统计数据
        - 使用场景:
        -   在前台 Memos 页面侧边栏展示统计卡片。
        - 逻辑:
        -   1. COUNT(*) 统计已发布 Memo 总数
        -   2. SUM(CHAR_LENGTH(content)) 统计总字数（CHAR_LENGTH 中文友好，1 个汉字 = 1）
        -   3. 使用 CASE WHEN 统计本月 Memo 数
        -   4. MAX(create_time) 获取最近一条 Memo 的时间
        -   5. 单条 SQL 一次查出 4 个统计值，只需 1 次数据库访问
    -->
    <select id="selectMemoStats" resultType="com.kmo.kome.dto.response.MemoStatsResponse">
        SELECT
            COUNT(*) AS total_count,
            COALESCE(SUM(CHAR_LENGTH(content)), 0) AS total_words,
            COUNT(CASE WHEN create_time >= DATE_FORMAT(NOW(), '%Y-%m-01') THEN 1 END) AS this_month_count,
            MAX(create_time) AS latest_date
        FROM memo
        WHERE status = 1 AND is_deleted = 0
    </select>

</mapper>
